<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

</head>

<body>
    <p>TESTE CHAT CLIENT</p>
    <!-- <script src="https://app4.pluslive.online/api/chat-widget.js"></script> -->
    <script>
        (function () {
            if (window.__chatWidgetLoaded) return; // evita duplica√ß√£o
            window.__chatWidgetLoaded = true;

            const loadScript = (src, callback) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = callback;
                document.head.appendChild(script);
            };

            loadScript("https://cdn.socket.io/4.7.2/socket.io.min.js", () => {
                const API_URL = "https://app4.pluslive.online";
                const messageSound = new Audio("https://notificationsounds.com/storage/sounds/file-sounds-1196-mmm-2.ogg");

                if ("Notification" in window && Notification.permission !== "granted") {
                    Notification.requestPermission();
                }
                let socket;
                let chatVisible = false;
                let chatToken = localStorage.getItem("chat_token");
                let formContainer = null;

                const chatButton = document.createElement("div");
                chatButton.innerText = "üí¨";
                Object.assign(chatButton.style, {
                    position: "fixed",
                    bottom: "20px",
                    right: "20px",
                    background: "#007bff",
                    color: "#fff",
                    borderRadius: "50%",
                    width: "60px",
                    height: "60px",
                    display: "flex",
                    justifyContent: "center",
                    alignItems: "center",
                    fontSize: "28px",
                    cursor: "pointer",
                    zIndex: 9999,
                });
                document.body.appendChild(chatButton);
                function showDesktopNotification(title, body) {
                    if (Notification.permission === "granted") {
                        const notification = new Notification(title, {
                            body: body,
                            icon: "https://cdn-icons-png.flaticon.com/512/1034/1034141.png", // opcional
                        });

                        // Fecha a notifica√ß√£o ap√≥s 5s
                        setTimeout(() => notification.close(), 5000);
                    }
                }
                chatButton.addEventListener("click", () => {
                    chatVisible = !chatVisible;
                    if (chatVisible) {
                        if (!formContainer) {
                            showPreForm();
                        } else {
                            formContainer.style.display = "block";
                        }
                    } else {
                        if (formContainer) formContainer.style.display = "none";
                    }
                });

                if (chatToken) {
                    chatVisible = true;
                    connectSocket();
                }
                function formatTime(timestamp) {
                    const date = new Date(Number(timestamp));

                    return date.toLocaleTimeString("pt-BR", {
                        day: "2-digit",
                        month: "2-digit",
                        hour: "2-digit",
                        minute: "2-digit"
                    });
                }
                function extrairNome(mensagem) {
                    const regex = /\*(.*?)\*/;
                    const match = mensagem.match(regex);
                    return match ? match[1] : "Atendente";
                }

                function showPreForm() {
                    formContainer = document.createElement("div");
                    formContainer.innerHTML = `
                <div style="position: fixed; bottom: 90px; right: 20px; background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); width: 320px; font-family: sans-serif; z-index: 9992;">
                    <h3 style="margin-top: 0; font-size: 1.2rem; color: #333;">Iniciar Atendimento</h3>
                    <label style="display: block; margin-bottom: 8px; color: #555;">Nome</label>
                    <input id="chat-name" placeholder="Digite seu nome" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px;" />
                    <label style="display: block; margin-bottom: 8px; color: #555;">E-mail</label>
                    <input id="chat-email" placeholder="Digite seu e-mail" style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px;" />
                    <label style="display: block; margin-bottom: 8px; color: #555;">CNPJ</label>
                    <input id="chat-cnpj" placeholder="Digite seu cnpj" maxlength="14" value="18273094000132" style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px;" />
                    <button id="chat-start-btn" style="width: 100%; padding: 12px; background: #007bff; color: #fff; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Iniciar Chat</button>
                </div>
            `;
                    document.body.appendChild(formContainer);

                    document.getElementById("chat-start-btn").addEventListener("click", async () => {
                        const name = document.getElementById("chat-name").value;
                        const email = document.getElementById("chat-email").value;
                        const identifier = document.getElementById("chat-cnpj").value;

                        if (!name || !email || !identifier) return alert("Preencha todos os campos.");
                        const startBtn = document.getElementById("chat-start-btn");
                        // Troca texto e desativa
                        startBtn.textContent = "Iniciando...";
                        startBtn.disabled = true;
                        try {
                            const res = await fetch(`${API_URL}/api/chatClient/token`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ name, email, identifier })
                            });
                            const { token, error } = await res.json();

                            if (error) {
                                alert(error);
                                startBtn.textContent = "Iniciar Chat"; // volta
                                startBtn.disabled = false;
                                return;
                            }
                            chatToken = token;
                            localStorage.setItem("chat_token", token);
                            formContainer.remove();
                            connectSocket();
                        } catch (err) {
                            console.error("Erro ao gerar token", err);
                            alert("N√£o foi poss√≠vel iniciar o chat.");
                            startBtn.textContent = "Iniciar Chat";
                            startBtn.disabled = false;
                        }
                    });
                }

                function connectSocket() {
                    if (formContainer) formContainer.remove();
                    socket = io(API_URL, {
                        auth: { token: chatToken },
                        transports: ["websocket"]
                    });

                    socket.on("connect", () => {
                        console.log("Conectado ao socket");
                        openChatUI();
                    });

                    socket.on("chat:reply", (msg) => {
                        const nome = extrairNome(msg);
                        const mensagemSemNome = msg.replace(/\*(.*?)\*:\s*/, ""); // Remove o nome da mensagem
                        appendMessage(nome, mensagemSemNome);
                        messageSound.play();
                        showDesktopNotification("Nova mensagem", msg);
                    });
                    socket.on("chat:image", (url) => appendImage(url));
                    socket.on("chat:previousMessages", (messages) => {
                        const loadingEl = document.getElementById("chat-loading");
                        if (loadingEl) loadingEl.remove();
                        console.log(messages)
                        messages.forEach((msg) => {
                            const timestamp = msg.timestamp || Date.now();

                            if (msg.type === "image") {
                                appendImage(msg.body, timestamp);
                            } else {
                                if (msg.fromMe) {
                                    const nome = extrairNome(msg.body);
                                    const mensagemSemNome = msg.body.replace(/\*(.*?)\*:\s*/, "");
                                    appendMessage(nome, mensagemSemNome, timestamp);
                                } else {
                                    appendMessage("Voc√™", msg.body, timestamp);
                                }
                            }
                        });
                    });

                    socket.on("connect_error", (err) => {
                        console.error("Erro de conex√£o:", err.message);
                        if (err.message.includes("invalid token")) {
                            alert("Sess√£o expirada. Recarregue e inicie novamente.");
                            localStorage.removeItem("chat_token");
                        }
                    });
                }

                function openChatUI() {
                    formContainer = document.createElement("div");
                    formContainer.innerHTML = `
                <style>
                    .chat-message { display: flex; margin-bottom: 8px; max-width: 80%; }
                    .chat-client { justify-content: flex-end; margin-left: auto; text-align: right; }
                    .chat-agent { justify-content: flex-start; margin-right: auto; text-align: left; }
                    .message-content { background: #f1f1f1; padding: 10px; border-radius: 12px; font-size: 14px; max-width: 100%; word-wrap: break-word; }
                    .chat-client .message-content { background: #d1e7ff; color: #000; }
                </style>

                <div style="position: fixed; bottom: 90px; right: 20px; background: white; border: 1px solid #ccc; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); width: 320px; padding: 12px; height: 400px; display: flex; flex-direction: column; z-index: 9999;">
                    <div style="display: flex; justify-content: space-between; align-items: center">
                        <small style="color: #999;">Conectado ao atendimento</small>
                        <button id="chat-close-btn" style="background: transparent; border: none; font-size: 16px; cursor: pointer;">‚úñ</button>
                    </div>
                    <div id="chat-messages" style="flex: 1; padding: 10px; overflow-y: auto;">
    <div id="chat-loading" style="text-align: center; color: #777;">Carregando mensagens...</div>
</div>

                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label for="file-upload" style="cursor: pointer;">üìé</label>
                        <input type="file" id="file-upload" accept="image/*" style="display:none" />
                        <input id="chat-input" placeholder="Digite sua mensagem" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;" />
                        <button id="chat-send-btn" style="padding: 8px 10px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">‚û§</button>
                    </div>
                </div>
            `;
                    document.body.appendChild(formContainer);
                    document.getElementById("chat-close-btn").addEventListener("click", () => {
                        const confirmClose = confirm("Deseja encerrar o atendimento?");
                        if (confirmClose) {
                            socket.emit("chat:end"); // voc√™ trata isso no servidor
                            localStorage.removeItem("chat_token"); // Remove o token salvo
                            chatToken = null;
                            chatVisible = false;
                            formContainer.remove();
                            formContainer = null; // importante para reexibir o formul√°rio depois;
                        }
                    });

                    document.getElementById("chat-send-btn").addEventListener("click", function (e) {
                        e.preventDefault();
                        const input = document.getElementById("chat-input");
                        const msg = input.value.trim();
                        if (!msg) return;
                        socket.emit("chat:message", msg);
                        appendMessage("Voc√™", msg);
                        input.value = "";
                    });

                    const fileInput = document.getElementById("file-upload");
                    fileInput.addEventListener("change", async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;

                        const formData = new FormData();
                        formData.append("file", file);

                        try {
                            const res = await fetch(`${API_URL}/api/chatClient/upload`, {
                                method: "POST",
                                headers: {
                                    Authorization: `Bearer ${chatToken}`,
                                },
                                body: formData
                            });
                            const data = await res.json();
                            if (data.url) {
                                socket.emit("chat:image", data.url);
                                appendImage(data.url);
                            } else {
                                alert("Erro ao enviar imagem");
                            }
                        } catch (err) {
                            console.error(err);
                            alert("Erro ao enviar imagem");
                        } finally {
                            // Reset input para permitir selecionar o mesmo arquivo novamente
                            fileInput.value = "";
                        }
                    });
                }

                function appendMessage(sender, text, timestamp = Date.now()) {
                    const messages = document.getElementById("chat-messages");
                    const el = document.createElement("div");
                    const isClient = sender === "Voc√™";
                    el.className = isClient ? "chat-message chat-client" : "chat-message chat-agent";
                    el.innerHTML = `<div class="message-content"><strong>${sender}:</strong> ${text}
                          <div style="font-size: 11px; color: #777; margin-top: 4px;">${formatTime(timestamp)}</div></div>`;
                    messages.appendChild(el);
                    messages.scrollTop = messages.scrollHeight;
                }

                function appendImage(url, timestamp = Date.now()) {
                    const messages = document.getElementById("chat-messages");
                    const el = document.createElement("div");
                    el.className = "chat-message chat-client";
                    el.innerHTML = `
                <div class="message-content">
                    <img src="${url}" style="max-width: 100%; border-radius: 8px; margin-top: 8px;" crossorigin="anonymous" />
                      <div style="font-size: 11px; color: #777; margin-top: 4px;">${formatTime(timestamp)}</div>
                </div>
            `;
                    messages.appendChild(el);
                    messages.scrollTop = messages.scrollHeight;
                }
            });
        })();

    </script>
</body>

</html>
